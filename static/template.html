<!DOCTYPE html>
<html>
<head>
    <title>PMAP to OMOP search</title>
</head>
<body>
    <h1>John Hopkins PMAP to OMOP mapping dictionary</h1>
    <h3 align="right">Sean Yen</h3>
    <p>
        This engine searches for every column, and returns all results.<br>
        The mapping relationship database is based on a screenshot on 2024/02/05 so any changes made after won't be detected.<br><br>
        It's just a prototype so have some patience for the slow query and primitive features!<br>
        <a href="https://google.com/" target="_blank">Feedback</a><br>
        (Fake link for now because I am not sure does using google survey violate safety rules)
    </p>
    <form id="searchForm">
        <input type="text" name="search_str" id="searchStr" placeholder="Search...">
        <input type="button" value="Search" onclick="initiateSearch()">
    </form>
    <div id="results"></div>
    <script>
        async function loadData(searchStr) {
            const newUrl = `${window.location.pathname}?search_str=${encodeURIComponent(searchStr)}`;
            window.history.pushState({ path: newUrl }, '', newUrl);

            const response = await fetch(`/api/search/?search_str=${encodeURIComponent(searchStr)}`);
            const data = await response.json();

            displayResults(data);
        }
    
        function addRow(rowData, table) {
            const row = document.createElement('tr');
            rowData.forEach(cellData => {
                const cell = document.createElement('td');
                cell.textContent = cellData;
                row.appendChild(cell);
            });
            table.appendChild(row);
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = ''; // Clear previous results

            if (data.result && data.result.length > 0) {
                const numResults = data.result.length;
                resultsContainer.innerHTML += `<p>${numResults} mapping relationships found.</p>`;
                const table = document.createElement('table');
                table.setAttribute('border', '1');
                table.setAttribute('id', 'resultsTable');
                
                const headerRow = document.createElement('tr');
                const columns = ['col1', 'col2']; // Example column headers
                columns.forEach(col => {
                    const headerCell = document.createElement('th');
                    headerCell.textContent = col;
                    headerRow.appendChild(headerCell);
                });
                table.appendChild(headerRow);
                resultsContainer.appendChild(table);
    
                data.result.forEach(row => {
                    addRow(row, table);
                });
            } else {
                resultsContainer.innerHTML = 'No results found.';
            }
        }

        function initiateSearch() {
            const searchStr = document.getElementById('searchStr').value;
            loadData(searchStr);
        }

        function checkForSearchOnLoad() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchStr = urlParams.get('search_str');
            if (searchStr) {
                document.getElementById('searchStr').value = searchStr;
                loadData(searchStr);
            }
        }

        window.onload = checkForSearchOnLoad;
    </script>    
</body>
</html>
